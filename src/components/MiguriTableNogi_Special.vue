<script setup>
import { ref } from 'vue'
import html2canvas from 'html2canvas';
let single = 38
let single_end = "th"
let single_title = "ãƒãƒ¼ãƒ–ãƒ«ã‚ªãƒ¬ãƒ³ã‚¸"
let single_hashtag = "#ä¹ƒæœ¨å‚46_ãƒãƒ¼ãƒ–ãƒ«ã‚ªãƒ¬ãƒ³ã‚¸"
let other_hashtag = "#ã•ã¤ãã¨ãƒ¼ã"
let sentence = "ğŸ©·ã€ŒãŠèŠå±…ã«è§¦ã‚Œã‚‹æ©Ÿä¼šã‚’ã„ãŸã ããŸã³ã€æ¼”ã˜ã‚‹ã“ã¨ã®æ¥½ã—ã•ã‚’çŸ¥ã£ã¦ã„ãã¾ã—ãŸã€ğŸ©µ"
let entry = "3" // entry can be "1", "1.5", "2", "2.5", "3" ...
let result_name = "3æ¬¡å¿œå‹Ÿçµæœ"//"ï¼‘æ¬¡å¿œå‹Ÿä¿éšœçµæœ"
let center = [] //ã‚»ãƒ³ã‚¿ãƒ¼ ï½¾ï¾ï¾€ï½°
let w_center = ["äº•ä¸Šå’Œ", "ä¸­è¥¿ã‚¢ãƒ«ãƒ"]
let row_1 = ["è³€å–œé¥é¦™", "é è—¤ã•ãã‚‰"] // ãƒ•ãƒ­ãƒ³ãƒˆ ï¾Œï¾›ï¾ï¾„
let fukujin = ["äº”ç™¾åŸèŒ‰å¤®", "æ± ç”°ç‘›ç´—", "å°å·å½©", "å·ï¨‘æ¡œ", "ä¸€ãƒç€¬ç¾ç©º", "ä¹…ä¿å²ç·’é‡Œ", "æ¢…æ¾¤ç¾æ³¢"]
let senbatsu = ["é‡‘å·ç´—è€¶", "ç”°æ‘çœŸä½‘", "ç­’äº•ã‚ã‚„ã‚", "æ—ç‘ å¥ˆ", "å¥¥ç”°ã„ã‚ã¯", "è…åŸå’²æœˆ", "å†¨é‡Œå¥ˆå¤®", "å¼“æœ¨å¥ˆæ–¼"]


const response = await fetch(`../nogi_special/result_${entry}.json`);
const data = await response.json();

let ki3 = ["ä¼Šè—¤ç†ã€…æ",
  "å²©æœ¬è“®åŠ ",
  "æ¢…æ¾¤ç¾æ³¢",
  "ä¹…ä¿å²ç·’é‡Œ",
  "ä½è—¤æ¥“",
  "ä¸­æ‘éº—ä¹ƒ",
  "å‰ç”°ç¶¾ä¹ƒã‚¯ãƒªã‚¹ãƒ†ã‚£ãƒ¼",
  "ä¸ç”°ç¥å¸Œ",]

let ki4 = ["é è—¤ã•ãã‚‰",
  "è³€å–œé¥é¦™",
  "é‡‘å·ç´—è€¶",
  "é»’è¦‹æ˜é¦™",
  "ä½è—¤ç’ƒæœ",
  "æŸ´ç”°æŸšèœ",
  "ç”°æ‘çœŸä½‘",
  "ç­’äº•ã‚ã‚„ã‚",
  "æ—ç‘ å¥ˆ",
  "æ¾å°¾ç¾ä½‘",
  "çŸ¢ä¹…ä¿ç¾ç·’",
  "å¼“æœ¨å¥ˆæ–¼",]

let ki5 = ["äº”ç™¾åŸèŒ‰å¤®",
  "æ± ç”°ç‘›ç´—",
  "ä¸€ãƒç€¬ç¾ç©º",
  "äº•ä¸Šå’Œ",
  "å²¡æœ¬å§«å¥ˆ",
  "å°å·å½©",
  "å¥¥ç”°ã„ã‚ã¯",
  "å·ï¨‘æ¡œ",
  "è…åŸå’²æœˆ",
  "å†¨é‡Œå¥ˆå¤®",
  "ä¸­è¥¿ã‚¢ãƒ«ãƒ"]

let ki6 = ["æ„›å®•å¿ƒéŸ¿",
  "å¤§è¶Šã²ãªã®",
  "å°æ´¥ç²å¥ˆ",
  "æµ·é‚‰æœ±è‰",
  "å·ç«¯æ™ƒèœ",
  "éˆ´æœ¨ä½‘æº",
  "ç€¬æˆ¸å£å¿ƒæœˆ",
  "é•·å¶‹å‡›æ¡œ",
  "å¢—ç”°ä¸‰è‰éŸ³",
  "æ£®å¹³éº—å¿ƒ",
  "çŸ¢ç”°èŒè¯"]

const getKi = {}

for (let index = 0; index < ki3.length; index++) {
  getKi[ki3[index]] = 3;
}
for (let index = 0; index < ki4.length; index++) {
  getKi[ki4[index]] = 4;
}
for (let index = 0; index < ki5.length; index++) {
  getKi[ki5[index]] = 5;
}
for (let index = 0; index < ki6.length; index++) {
  getKi[ki6[index]] = 6;
}



let parsed = []
let dates = []
let available = [0, 0, 0, 0, 0, 0, 0]  // total, 1ki, 2ki, 3ki, 4ki, 5ki
let sold = [0, 0, 0, 0, 0, 0, 0]
let soldThisTime = [0, 0, 0, 0, 0, 0, 0]

for (const memberName in data) {
  if (Object.hasOwnProperty.call(data, memberName)) {
    const memberData = data[memberName];
    const parsedMerberData = { "name": memberName, "available": 0, "sold": 0, "soldThisTime": 0, "list": [], "P": "" }
    for (const dateData in memberData) {

      if (!dates.includes(dateData) && dateData != "P") {

        dates.push(dateData)
      }
      //dates = ["1æœˆ26æ—¥", "2æœˆ2æ—¥", "2æœˆ16æ—¥"]

      if (Object.hasOwnProperty.call(memberData, dateData)) {


        for (let index = 0; index < memberData[dateData].length; index++) {
          if (dateData == "P") {
            parsedMerberData.P = memberData[dateData]
            break
          }

          const element = memberData[dateData][index];
          // element can be "-1", "false", "1", "1.5", "2", "2.5", "3" ... 
          if (element != "-1") {
            parsedMerberData.available += 1
            available[0] += 1
            available[getKi[memberName]] += 1
          }
          if (element != "-1" && element != false) {
            parsedMerberData.sold += 1
            sold[0] += 1
            sold[getKi[memberName]] += 1
          }
          if (element == entry) { // entry can be "1", "1.5", "2", "2.5", "3" ... 
            parsedMerberData.soldThisTime += 1
            soldThisTime[0] += 1
            soldThisTime[getKi[memberName]] += 1
          }
          if (element == false) {
            parsedMerberData.list.push("0")
          }
          else {
            parsedMerberData.list.push(element)
          }

        }


      }
    }
    parsed.push(parsedMerberData)


  }
}

// let sorted_parsed = []
// // does not work
// // for (let index = 0; index < parsed.length; index++) {
// //   sorted_parsed.push(parsed[index]);
// // }
// // does not work as well
// // sorted_parsed = Array.from(parsed);
// sorted_parsed = JSON.parse(JSON.stringify(parsed))
// sorted_parsed.sort((a, b) => {
//   if (a.sold == a.available && b.sold != b.available) {
//     return -1
//   }
//   if (a.sold != a.available && b.sold == b.available) {
//     return 1
//   }

//   // both sold, compare who first
//   if (a.sold == a.available && b.sold == b.available) {
//     if (Math.max(...a.list) < Math.max(...b.list)) {
//       return -1
//     }
//     if (Math.max(...a.list) > Math.max(...b.list)) {
//       return 1
//     }
//     // if same, continue to next comparation
//   }

//   // compare all previous results from last time
//   for (let index = entry; index > 0; index--) {
//     let a_sold = a.list.reduce((sold, list_item) => { return list_item > 0 && list_item <= index ? sold += 1 : sold += 0 }, 0)
//     let b_sold = b.list.reduce((sold, list_item) => { return list_item > 0 && list_item <= index ? sold += 1 : sold += 0 }, 0)
//     console.log(a.list, b.list, a_sold, b_sold, index)
//     if (a_sold > b_sold) {
//       return -1
//     }
//     if (a_sold < b_sold) {
//       return 1
//     }
//   }

//   // same in every sense 
//   return 0
// })
//
// for (let index = 0; index < sorted_parsed.length; index++) {
//   sorted_parsed[index].list = sorted_parsed[index].list.sort((a, b) => {
//     // -1 at end
//     if (a == -1) {
//       return 1
//     }
//     if (b == -1) {
//       return -1
//     }
//     // 0 just before -1
//     if (a == 0) {
//       return 1
//     }
//     if (b == 0) {
//       return -1
//     }
//     return a - b
//   })

// }

console.log(parsed, dates, available, sold, soldThisTime)

const captureScreenshot = () => {
  const mainElement = document.querySelectorAll(".main")[0];

  const imgElement = document.querySelectorAll("img")[0];

  html2canvas(mainElement).then(canvas => {
    // Convert canvas to data URL
    const dataUrl = canvas.toDataURL('image/png');
    //     console.log(dataUrl)
    //     setTimeout(() => {
    //     window.open(dataUrl, "_blank");
    // }, 100);
    // const link = document.createElement('a');
    // link.href = dataUrl;
    // link.target = '_blank';
    // link.click();
    // const newWindow = window.open();
    // if (newWindow) {
    //     newWindow.document.write(`<img src="${dataUrl}" alt="Canvas Image"/>`);
    // } else {
    //     console.error("Popup blocked or window.open failed!");
    // }
    // Open data URL in new tab
    // const newTab = window.open();
    // newTab.document.write('<img src="' + dataUrl + '">');
    imgElement.src = dataUrl
    // //mainElement.style.display = "none"
  }).catch(err => {
    console.error('Error capturing screenshot:', err);
  });

}

const one_to_30 = []
for (let index = 1; index <= 30; index++) {
  one_to_30.push(index)
}

setTimeout(captureScreenshot, 1500)
setTimeout(() => { window.location.reload() }, 15000)
</script>

<template>
  This site should be displayed under 100% zoom<br><br>
  <a :href="`https://ticket.fortunemeets.app/data/nogizaka46/38th/config.json`">
    https://ticket.fortunemeets.app/data/nogizaka46/38th/config.json
  </a>
  <br><br>
  <a :href="`https://ticket.fortunemeets.app/nogizaka46/38th`">
    https://ticket.fortunemeets.app/nogizaka46/38th
  </a>
  <br><br>
  <!-- #å§«å¥ˆãŠã‚ã§ã¨ã†<br>
  #ã‚„ã£ã±ã‚Š5æœŸç”ŸãŒå¤§å¥½ããªã‚“ã§ã™ã‚ˆ<br> -->
  ä¹ƒæœ¨å‚46 {{ single }}{{ single_end }}ã‚·ãƒ³ã‚°ãƒ«ã€Œ{{ single_title }}ã€ã‚¹ãƒšã‚·ãƒ£ãƒ«æŠ½é¸å¿œå‹Ÿ {{ result_name }}<br>
  #ä¹ƒæœ¨å‚46 #Nogizaka46<br>
  #ä¹ƒæœ¨å‚46å®Œå£²è¡¨<br>
  {{ single_hashtag }}<br>
  {{ other_hashtag }}<br>
  <img src="" style="max-width: 800px;"></img>
  <img src="" style="max-width: 800px;"></img>
  <section id="miguri_table" class="main" style="padding: 5px">
    <div class="container svelte-6daqx1">
      <table class="table-bordered svelte-6daqx1" style="border-collapse: collapse;">
        <!-- table-layout: fixed;width: 100%; -->

        <thead>
          <tr>
            <th style="font-size: larger;font-weight: bolder;" class="bottom-border" colspan="15">
              ä¹ƒæœ¨å‚46 {{ single }}{{ single_end }}ã‚·ãƒ³ã‚°ãƒ« ã€Œ{{ single_title }}ã€
              ã‚¹ãƒšã‚·ãƒ£ãƒ«æŠ½é¸å¿œå‹Ÿ {{ result_name }}</th>
          </tr>
          <tr>

            <th style="max-width:200px;width:200px;font-weight: normal;" class="right-align">TT@x.com/itsunogi46</th>

            <th v-for="date in dates.slice(0, 2)" :key="date" class="left-border" colspan="4"
              style="width: 120px; font-weight: normal">
              {{ date.replace("ï¼ˆæ—¥ï¼‰", "(æ—¥)").replace("2024å¹´", "").replace("2025å¹´", "") }}(ãƒªã‚¢ãƒ«)
            </th>

            <th v-for="date in dates.slice(2, 3)" :key="date" class="left-border" colspan="5"
              style="width: 300px; font-weight: normal">
              {{ date.replace("ï¼ˆæ—¥ï¼‰", "(æ—¥)").replace("2024å¹´", "").replace("2025å¹´", "") }}(ã‚ªãƒ³ãƒ©ã‚¤ãƒ³)
            </th>


            <th class="left-border left-align" style="max-width: 160px;width:160px;font-weight: normal">
              {{ sold[0] }}/{{ available[0] }} (+{{ soldThisTime[0] }})
            </th>
          </tr>
        </thead>
        <tbody>

          <template v-for="ki in [3, 4, 5, 6]">
            <tr class="top-border bottom-border lighter-purple-bg">

              <td style="font-weight: bold;" class="right-align">
                <span>{{ sold[ki] === available[ki] ? "(å®Œå£²)" : "" }}</span>
                {{ ki }}æœŸç”Ÿ
              </td>
              <td class="text-white left-border">1</td>
              <td class="text-white">2</td>
              <td class="text-white">3</td>
              <td class="text-white">4</td>
              <td class="text-white left-border">1</td>
              <td class="text-white">2</td>
              <td class="text-white">3</td>
              <td class="text-white">4</td>
              <td class="text-white left-border">1</td>
              <td class="text-white">2</td>
              <td class="text-white">3</td>
              <td class="text-white">4</td>
              <td class="text-white" style="width: 180px;">ãƒšã‚¢</td>

              <td class="left-align left-border">{{ sold[ki] }}/{{ available[ki] }} (+{{ soldThisTime[[ki]] }})</td>
            </tr>



            <tr v-for="(member, index) in parsed.filter(member => getKi[member.name] == ki)" :key="member" class="">

              <td class="memberName right-align" :class="{ 'lighter-purple-bg': member.sold === member.available }">
                <span
                  :class="{ 'text-bold': member.sold === member.available && Math.max(...member.list).toString() === entry }">
                  {{ member.sold === member.available ? "(" + (Math.max(...member.list) +
                    "æ¬¡").toString().replace(".5æ¬¡", "æ¬¡ä¿éšœ") + "å®Œå£²)" : "" }}
                </span>
                {{ member.name }}

              </td>
              <td v-for="(partStatus, index) in member.list"
                :class="{ 'part-width': true, 'left-border': (index) % 4 === 0, 'sold-this-time': partStatus == entry }">
                {{ partStatus == -1 ? "-" : partStatus == 0 ? " " : partStatus.replace(".5", "ä¿") }}
              </td>

              <td>{{ member.P }}</td>

              <td class="left-align left-border" :class="{ 'lighter-purple-bg': member.sold === member.available }">
                {{ member.sold }}/{{ member.available }} (+{{ member.soldThisTime }})
                <span>{{ center.includes(member.name) ? "/ ï½¾ï¾ï¾€ï½°" : "" }}</span>
                <span>{{ w_center.includes(member.name) ? "/ Wï½¾ï¾ï¾€ï½°" : "" }}</span>
                <span>{{ row_1.includes(member.name) ? "/ ï¾Œï¾›ï¾ï¾„" : "" }}</span>
                <span>{{ fukujin.includes(member.name) ? "/ ç¦ç¥" : "" }}</span>
                <span>{{ senbatsu.includes(member.name) ? "/ é¸æŠœ" : "" }}</span>
              </td>
            </tr>
          </template>



        </tbody>
      </table>
      <div style="font-size: smaller;"><span style="color: white;">AAAA</span>{{ sentence }}</div>
      <div style="text-align: right;"></div>
      <!-- x.com/itsunogi46 -->
    </div>
    <!--
    <div class="container svelte-6daqx1">
      <table class="table-bordered svelte-6daqx1" style="border-collapse: collapse;">
        
        <caption style="font-size: larger;font-weight: bolder;" class="">ä¹ƒæœ¨å‚46 {{ single }}{{ single_end }}ã‚·ãƒ³ã‚°ãƒ« ã€Œ{{
          single_title }}ã€
          ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ ãƒŸãƒ¼ãƒˆï¼†ã‚°ãƒªãƒ¼ãƒˆ
          {{ entry }}æ¬¡æŠ½é¸çµæœ</caption>
        <thead>
          <tr>

            <th style="max-width:180px;width:180px;font-weight: normal;" class="right-align">TT@å°å‰æ¿€æ¨ã—ä¸­</th>

            <th v-for="number in one_to_30" :key="number" colspan="1" style="width: 18px; font-weight: normal">
              {{ number }}
            </th>
            <th class="left-align" style="max-width: 140px;width:140px;font-weight: normal">
              {{ sold[0] }}/{{ available[0] }} (+{{ soldThisTime[0] }})
            </th>
          </tr>
        </thead>
        <tbody>

          <tr v-for="(member, index) in sorted_parsed" :key="member" class="">

            <td class="memberName right-align" :class="{ 'lighter-purple-bg': member.sold === member.available }">
              <span :class="{ 'text-bold': member.sold === member.available && Math.max(...member.list) === entry }">
                {{ member.sold === member.available ? "(" + Math.max(...member.list) + "æ¬¡å®Œå£²)" : "" }}
              </span>
              {{ member.name }}

            </td>
            <td v-for="(partStatus, index) in member.list " :class="{
              'part-width': true,
              'partStatus1': partStatus == 1,
              'partStatus2': partStatus == 2,
              'partStatus3': partStatus == 3,
              'partStatus4': partStatus == 4,
              'partStatus5': partStatus == 5,
              'partStatus6': partStatus == 6,
              'partStatus7': partStatus == 7,
              'partStatus8': partStatus == 8,
              'partStatus9': partStatus == 9,
              'partStatus10': partStatus == 10,
              'partStatus11': partStatus == 11,
              'partStatus12': partStatus == 12,
              'partStatus13': partStatus == 13,
              'partStatus14': partStatus == 14,
              'partStatus15': partStatus == 15,
              'partStatus16': partStatus == 16,
              'partStatus17': partStatus == 17,
              'partStatus18': partStatus == 18,
              'partStatus19': partStatus == 19,
              'partStatus20': partStatus == 20,
            }">

              {{ partStatus == -1 ? "-" : partStatus == 0 ? " " : partStatus }}
            </td>
            <td class="left-align" :class="{ 'lighter-purple-bg': member.sold === member.available }">
              {{ member.sold }}/{{ member.available }} (+{{ member.soldThisTime }})
              <span>{{ center.includes(member.name) ? "(ã‚»ãƒ³ã‚¿ãƒ¼)" : "" }}</span>
              <span>{{ fukujin.includes(member.name) ? "(ç¦ç¥)" : "" }}</span>
              <span>{{ senbatsu.includes(member.name) ? "(é¸æŠœ)" : "" }}</span>
            </td>
          </tr>




        </tbody>
      </table>
    </div>-->

  </section>
</template>

<style scoped>
table {
  border: 2px #812990 solid;
  table-layout: fixed;
}

th,
td {
  border: 0.1px #812990 solid;
  height: 5px;
}

.text-bold {
  font-weight: bolder;
}

.lighter-purple-bg {
  background-color: #eac9f0;
}

.partStatus1 {
  background-color: #eac9f0;
  /* ç²‰ç´«ï¼ˆå›ºå®šï¼‰ */
}

.partStatus2 {
  background-color: #FFCC66;
  /* æµ…é»„è‰² */
}

.partStatus3 {
  background-color: #FFE8B3;
  /* æµ…é»„ç»¿ */
}

.partStatus4 {
  background-color: #E6F5B0;
  /* æŸ”å’Œè‰ç»¿è‰² */
}

.partStatus5 {
  background-color: #CFFFD0;
  /* æµ…é’ç»¿ */
}

.partStatus6 {
  background-color: #A8F3D5;
  /* æ¸…æ–°è–„è·ç»¿ */
}

.partStatus7 {
  background-color: #A8F0E5;
  /* æµ…é’è“ */
}

.partStatus8 {
  background-color: #A8E3FF;
  /* æŸ”å’Œå¤©è“ */
}

.partStatus9 {
  background-color: #AAD8FF;
  /* æŸ”å’Œæµ…è“ */
}

.partStatus10 {
  background-color: #99CCFF;
  /* æ˜äº®æµ…è“ */
}

.partStatus11 {
  background-color: #A5B8FF;
  /* æµ…ç´«è“ */
}

.partStatus12 {
  background-color: #B3A8FF;
  /* æŸ”å’Œæµ…ç´« */
}

.partStatus13 {
  background-color: #C5B3FF;
  /* æµ…ç´«åè“ */
}

.partStatus14 {
  background-color: #DAC9FF;
  /* æŸ”å’Œæ·¡ç´« */
}

.partStatus15 {
  background-color: #F3D8FF;
  /* æµ…ç²‰ç´« */
}

.partStatus16 {
  background-color: #FFEAF8;
  /* æŸ”å’Œç²‰ç™½ */
}

.partStatus17 {
  background-color: #FFF5EE;
  /* ææµ…æš–ç²‰ç™½ */
}

.partStatus18 {
  background-color: #FFF8F0;
  /* æŸ”å’Œæš–ç™½ */
}

.partStatus19 {
  background-color: #FFF9F5;
  /* ææ·¡ç²‰ç™½ */
}

.partStatus20 {
  background-color: #FFFDFE;
  /* æ¥è¿‘çº¯ç™½ï¼ˆå›ºå®šï¼‰ */
}

.light-purple-bg {
  background-color: #daa0e4;
}

.left-border {
  border-left: 2px #812990 solid;

}

.right-border {

  border-right: 2px #812990 solid;
}

.top-border {
  border-top: 2px #812990 solid;

}

.bottom-border {

  border-bottom: 2px #812990 solid;
}

.part-width {
  max-width: 10px;
}

.left-align {
  text-align: left;
  padding-left: 10px;
}

.right-align {
  text-align: right;
  padding-right: 10px;
}

.sold-this-time {
  font-weight: bolder;
  color: #812990;
  background-color: #daa0e4;
}
</style>